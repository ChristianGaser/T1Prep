<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>T1Prep Web UI</title>
  <link rel="icon" type="image/png" href="/static/icons8-gehirn-50.png">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body data-theme="dark">
  <div class="container">
    <header>
      <div>
        <h1>T1Prep Web UI</h1>
        <p>Upload NIfTI files and configure options. Scheduling is optional.</p>
        <p class="hint"><kbd>Tab</kbd> to confirm field entries and update file list &bull; <kbd>Return</kbd> to submit the job</p>
      </div>
      <button class="theme-toggle" type="button" id="theme-toggle">Dark mode</button>
    </header>

    <form id="t1prep-form" action="/submit" method="post" enctype="multipart/form-data">
    <fieldset>
      <legend>Inputs</legend>

      <fieldset class="sub-fieldset" id="input-files-fieldset">
        <legend>Input Files <span class="required">*</span></legend>
        <label>
          Input NIfTI files
          <input id="file-input" class="file-input-hidden" type="file" name="inputs" multiple accept=".nii,.nii.gz,application/gzip,application/x-gzip">
          <div class="file-input-row">
            <button id="file-button" type="button" class="file-button">Select files</button>
            <span id="file-summary" class="file-summary">No files selected</span>
          </div>
        </label>
        <div id="dropzone" class="dropzone">
          Drag & drop files here
        </div>
        <div id="file-list" class="file-list"></div>
        <label>
          Or select by folder + pattern
          <span class="input-icon" data-icon="ðŸ“"><input type="text" name="folder_root" placeholder="/path/to/folder"></span>
        </label>
        <label>
          File pattern (recursive)
          <span class="input-icon" data-icon="ðŸ”"><input type="text" name="file_pattern" placeholder="**/*.nii*"></span>
        </label>
        <input type="hidden" name="removed_pattern_files" id="removed-pattern-files" value="">
        <div id="pattern-list" class="file-list"></div>
      </fieldset>

      <fieldset class="sub-fieldset">
        <legend>Output Directory</legend>
        <label>
          Auto-filled when using folder+pattern
          <span class="input-icon input-required" data-icon="ðŸ’¾"><input type="text" name="out_dir" required placeholder="/path/to/output"></span>
        </label>
      </fieldset>

      <fieldset class="sub-fieldset">
        <legend>Scheduling</legend>
        <label>
          Start at (optional)
          <span class="input-icon" data-icon="ðŸ•"><input type="datetime-local" name="start_at"></span>
        </label>
      </fieldset>
    </fieldset>

    <fieldset>
      <legend>General Options</legend>
      <div class="checkbox-row">
        <label><input type="checkbox" name="--debug" value="1" {% if debug %}checked{% endif %}> Debug</label>
      </div>
      <label>
        Parallel jobs
        <span class="input-icon" data-icon="âš¡"><input type="number" name="--multi" value="{{ multi }}" placeholder="-1 for auto"></span>
      </label>
      <label>
        Minimum memory per job (GB)
        <span class="input-icon" data-icon="ðŸ§ "><input type="number" name="--min-memory" value="{{ min_memory }}" step="1" placeholder="24"></span>
      </label>
    </fieldset>

    <fieldset>
      <legend>Save Options</legend>
      <label>
        No-overwrite pattern
        <span class="input-icon" data-icon="ðŸ›¡ï¸"><input type="text" name="--no-overwrite" value="{{ no_overwrite }}" placeholder="surf/lh.thickness."></span>
      </label>

      <fieldset class="sub-fieldset">
        <legend>Volume Atlases</legend>
        <div class="atlas-panel">
          <div class="atlas-header">Available atlases</div>
          <div class="atlas-grid">
            {% for atlas_name in atlas_names %}
              <label>
                <input type="checkbox" name="atlas_choice" value="{{ atlas_name }}" {% if atlas_name in atlas_selected %}checked{% endif %}>
                {{ atlas_name }}
              </label>
            {% endfor %}
          </div>
        </div>
        <label>
          Custom atlas file (.nii or .nii.gz)
          <input id="atlas-file-input" class="file-input-hidden" type="file" name="atlas_file" accept=".nii,.nii.gz,.gz,application/gzip,application/x-gzip">
          <div class="file-input-row">
            <button id="atlas-file-button" type="button" class="file-button">Select file</button>
            <span id="atlas-file-summary" class="file-summary">No file selected</span>
          </div>
        </label>
      </fieldset>

      <fieldset class="sub-fieldset">
        <legend>Surface Atlases</legend>
        <div class="atlas-panel">
          <div class="atlas-header">Available atlases</div>
          <div class="atlas-grid">
            {% for atlas_name in surface_atlas_names %}
              <label>
                <input type="checkbox" name="surface_atlas_choice" value="{{ atlas_name }}" {% if atlas_name in surface_atlas_selected %}checked{% endif %}>
                {{ atlas_name }}
              </label>
            {% endfor %}
          </div>
        </div>
        <label>
          Custom atlas file (.annot)
          <input id="surface-atlas-file-input" class="file-input-hidden" type="file" name="surface_atlas_file" accept=".annot">
          <div class="file-input-row">
            <button id="surface-atlas-file-button" type="button" class="file-button">Select file</button>
            <span id="surface-atlas-file-summary" class="file-summary">No file selected</span>
          </div>
        </label>
      </fieldset>

      <fieldset class="sub-fieldset">
        <legend>Processing Options</legend>
        <div class="checkbox-row">
          <label><input type="checkbox" name="--bids" value="1" {% if use_bids %}checked{% endif %}> BIDS naming</label>
          <label><input type="checkbox" name="--gz" value="1" {% if gz %}checked{% endif %}> Save .nii.gz</label>
          <label><input type="checkbox" name="--skullstrip-only" value="1" {% if skullstrip_only %}checked{% endif %}> Skullstrip only</label>
          <label><input type="checkbox" name="--no-skullstrip" value="1" {% if skip_skullstrip %}checked{% endif %}> Skip skullstrip</label>
          <label><input type="checkbox" name="--no-surf" value="1" {% if no_surf %}checked{% endif %}> No surface</label>
          <label><input type="checkbox" name="--no-seg" value="1" {% if no_seg %}checked{% endif %}> No segmentation</label>
          <label><input type="checkbox" name="--amap" value="1" {% if amap %}checked{% endif %}> AMAP segmentation</label>
          <label><input type="checkbox" name="--no-sphere-reg" value="1" {% if no_sphere_reg %}checked{% endif %}> No sphere registration</label>
          <label><input type="checkbox" name="--no-mwp" value="1" {% if no_mwp %}checked{% endif %}> No modulated/warped seg</label>
          <label><input type="checkbox" name="--no-atlas" value="1" {% if no_atlas %}checked{% endif %}> No volumetric atlas</label>
          <label><input type="checkbox" name="--pial-white" value="1" {% if pial_white %}checked{% endif %}> Pial + white surfaces</label>
          <label><input type="checkbox" name="--hemi" value="1" {% if hemi %}checked{% endif %}> Save hemispheric seg</label>
          <label><input type="checkbox" name="--wp" value="1" {% if wp %}checked{% endif %}> Save warped seg</label>
          <label><input type="checkbox" name="--rp" value="1" {% if rp %}checked{% endif %}> Save affine seg</label>
          <label><input type="checkbox" name="--p" value="1" {% if p %}checked{% endif %}> Save native seg</label>
          <label><input type="checkbox" name="--csf" value="1" {% if csf %}checked{% endif %}> Save CSF seg</label>
          <label><input type="checkbox" name="--lesions" value="1" {% if lesions %}checked{% endif %}> Save lesion seg</label>
        </div>
      </fieldset>
    </fieldset>

    <div class="actions">
      <button type="submit">Create Job</button>
      <a href="/jobs">View Jobs</a>
    </div>
  </form>

  <script>
    const themeToggle = document.getElementById("theme-toggle");
    const savedTheme = localStorage.getItem("t1prep-theme") || "dark";
    document.body.setAttribute("data-theme", savedTheme);
    themeToggle.textContent = savedTheme === "dark" ? "Light mode" : "Dark mode";

    themeToggle.addEventListener("click", () => {
      const next = document.body.getAttribute("data-theme") === "dark" ? "light" : "dark";
      document.body.setAttribute("data-theme", next);
      localStorage.setItem("t1prep-theme", next);
      themeToggle.textContent = next === "dark" ? "Light mode" : "Dark mode";
    });

    const fileInput = document.getElementById("file-input");
    const fileButton = document.getElementById("file-button");
    const fileSummary = document.getElementById("file-summary");
    const dropzone = document.getElementById("dropzone");
    const fileList = document.getElementById("file-list");
    const patternList = document.getElementById("pattern-list");
    const removedPatternField = document.getElementById("removed-pattern-files");
    const folderRootInput = document.querySelector("input[name='folder_root']");
    const filePatternInput = document.querySelector("input[name='file_pattern']");
    const outDirInput = document.querySelector("input[name='out_dir']");
    let selectedFiles = [];
    let patternFiles = [];
    let removedPattern = new Set();

    // Auto-populate output directory from file path
    async function suggestOutputDir(pathValue, force = false) {
      if (!pathValue) return;
      // Skip if already set and not forcing
      if (!force && outDirInput.value.trim()) return;
      const url = new URL("/resolve-dirname", window.location.origin);
      url.searchParams.set("path", pathValue);
      try {
        const response = await fetch(url.toString());
        if (!response.ok) return;
        const data = await response.json();
        if (data.dirname) {
          outDirInput.value = data.dirname;
        }
      } catch (error) {
        // Ignore errors
      }
    }

    function syncFileInput() {
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach((file) => dataTransfer.items.add(file));
      fileInput.files = dataTransfer.files;
    }

    function renderFileList() {
      fileList.innerHTML = "";
      if (selectedFiles.length === 0) {
        fileSummary.textContent = "No files selected";
      } else if (selectedFiles.length === 1) {
        fileSummary.textContent = selectedFiles[0].name;
      } else {
        fileSummary.textContent = `${selectedFiles.length} files selected`;
      }
      selectedFiles.forEach((file, index) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "file-chip";
        chip.textContent = file.name;
        chip.title = "Click to remove";
        chip.addEventListener("click", () => {
          selectedFiles.splice(index, 1);
          syncFileInput();
          renderFileList();
        });
        fileList.appendChild(chip);
      });
    }

    function renderPatternList() {
      patternList.innerHTML = "";
      const visible = patternFiles.filter((path) => !removedPattern.has(path));
      visible.forEach((path) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "file-chip";
        chip.textContent = path;
        chip.title = "Click to remove";
        chip.addEventListener("click", () => {
          removedPattern.add(path);
          removedPatternField.value = Array.from(removedPattern).join("||");
          renderPatternList();
        });
        patternList.appendChild(chip);
      });
    }

    async function updatePatternList() {
      const folderRoot = folderRootInput.value.trim();
      const filePattern = filePatternInput.value.trim();
      if (!folderRoot || !filePattern) {
        patternFiles = [];
        removedPattern.clear();
        removedPatternField.value = "";
        renderPatternList();
        return;
      }
      const url = new URL("/resolve-pattern", window.location.origin);
      url.searchParams.set("folder_root", folderRoot);
      url.searchParams.set("file_pattern", filePattern);
      try {
        const response = await fetch(url.toString());
        if (!response.ok) return;
        const data = await response.json();
        patternFiles = Array.isArray(data.files) ? data.files : [];
        const stillRemoved = new Set();
        removedPattern.forEach((path) => {
          if (patternFiles.includes(path)) {
            stillRemoved.add(path);
          }
        });
        removedPattern = stillRemoved;
        removedPatternField.value = Array.from(removedPattern).join("||");
        renderPatternList();
        clearInputError();
        // Auto-fill output directory from first file's dirname
        if (patternFiles.length > 0) {
          suggestOutputDir(patternFiles[0], true);
        }
      } catch (error) {
        // Ignore preview errors.
      }
    }

    fileInput.addEventListener("change", async () => {
      selectedFiles = Array.from(fileInput.files);
      renderFileList();
      clearInputError();
      // For uploaded files, browsers don't expose full path for security.
      // Set a default output directory if not already set.
      if (selectedFiles.length > 0 && !outDirInput.value.trim()) {
        try {
          const response = await fetch("/get-default-output");
          if (response.ok) {
            const data = await response.json();
            if (data.default_output) {
              outDirInput.value = data.default_output;
            }
          }
        } catch (error) {
          // Ignore errors
        }
      }
    });

    folderRootInput.addEventListener("blur", () => {
      updatePatternList();
      suggestOutputDir(folderRootInput.value.trim());
    });
    filePatternInput.addEventListener("blur", updatePatternList);

    fileButton.addEventListener("click", () => {
      fileInput.click();
    });

    // Form validation: ensure at least one input file is selected
    const form = document.getElementById("t1prep-form");
    const inputFilesFieldset = document.getElementById("input-files-fieldset");

    function clearInputError() {
      const hasUploadedFiles = selectedFiles.length > 0;
      const hasPatternFiles = patternFiles.filter((p) => !removedPattern.has(p)).length > 0;
      if (hasUploadedFiles || hasPatternFiles) {
        inputFilesFieldset.classList.remove("error");
      }
    }

    form.addEventListener("submit", (event) => {
      const hasUploadedFiles = selectedFiles.length > 0;
      const hasPatternFiles = patternFiles.filter((p) => !removedPattern.has(p)).length > 0;

      if (!hasUploadedFiles && !hasPatternFiles) {
        event.preventDefault();
        inputFilesFieldset.classList.add("error");
        alert("Please select at least one input file or specify a folder with pattern.");
        return false;
      }
      inputFilesFieldset.classList.remove("error");
    });

    dropzone.addEventListener("dragover", (event) => {
      event.preventDefault();
      dropzone.classList.add("dragover");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("dragover");
    });

    dropzone.addEventListener("drop", (event) => {
      event.preventDefault();
      dropzone.classList.remove("dragover");
      if (!event.dataTransfer || !event.dataTransfer.files.length) return;
      selectedFiles = Array.from(event.dataTransfer.files);
      syncFileInput();
      renderFileList();
      clearInputError();
    });

    // Custom atlas file button
    const atlasFileInput = document.getElementById("atlas-file-input");
    const atlasFileButton = document.getElementById("atlas-file-button");
    const atlasFileSummary = document.getElementById("atlas-file-summary");

    atlasFileButton.addEventListener("click", () => {
      atlasFileInput.click();
    });

    atlasFileInput.addEventListener("change", () => {
      if (atlasFileInput.files.length > 0) {
        atlasFileSummary.textContent = atlasFileInput.files[0].name;
      } else {
        atlasFileSummary.textContent = "No file selected";
      }
    });

    // Custom surface atlas file button
    const surfaceAtlasFileInput = document.getElementById("surface-atlas-file-input");
    const surfaceAtlasFileButton = document.getElementById("surface-atlas-file-button");
    const surfaceAtlasFileSummary = document.getElementById("surface-atlas-file-summary");

    surfaceAtlasFileButton.addEventListener("click", () => {
      surfaceAtlasFileInput.click();
    });

    surfaceAtlasFileInput.addEventListener("change", () => {
      if (surfaceAtlasFileInput.files.length > 0) {
        surfaceAtlasFileSummary.textContent = surfaceAtlasFileInput.files[0].name;
      } else {
        surfaceAtlasFileSummary.textContent = "No file selected";
      }
    });
  </script>
  </div>
</body>
</html>
