<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Job {{ job.id }}</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body data-theme="dark">
  <div class="container">
    <header>
      <div>
        <h1>Job {{ job.id }}</h1>
        <p><a href="/jobs">Back to jobs</a> | <a href="/">New job</a></p>
      </div>
      <button class="theme-toggle" type="button" id="theme-toggle">Dark mode</button>
    </header>

  <div class="card meta">
    <p><strong>Status:</strong> {{ job.status }}</p>
    <p><strong>Created:</strong> {{ job.created_at }}</p>
    <p><strong>Scheduled for:</strong> {{ job.scheduled_for or "" }}</p>
    <p><strong>Started:</strong> {{ job.started_at or "" }}</p>
    <p><strong>Finished:</strong> {{ job.finished_at or "" }}</p>
    <p><strong>Return code:</strong> {{ job.return_code if job.return_code is not none else "" }}</p>
  </div>

  <h2>Command</h2>
  <pre>{{ job.command_display }}</pre>

  <h2>Progress</h2>
  <div class="card progress-panel">
    <div class="progress-track">
      <div id="progress-bar" class="progress-bar"></div>
    </div>
    <div class="progress-meta">
      <span id="progress-label">Waiting for progress…</span>
      <span id="progress-percent">0%</span>
    </div>
  </div>

  <h2>Log</h2>
  <pre id="log-output">{{ log_content }}</pre>

  <script>
    const themeToggle = document.getElementById("theme-toggle");
    const savedTheme = localStorage.getItem("t1prep-theme") || "dark";
    document.body.setAttribute("data-theme", savedTheme);
    themeToggle.textContent = savedTheme === "dark" ? "Dark mode" : "Light mode";

    themeToggle.addEventListener("click", () => {
      const next = document.body.getAttribute("data-theme") === "dark" ? "light" : "dark";
      document.body.setAttribute("data-theme", next);
      localStorage.setItem("t1prep-theme", next);
      themeToggle.textContent = next === "dark" ? "Dark mode" : "Light mode";
    });

    const logOutput = document.getElementById("log-output");
    const progressBar = document.getElementById("progress-bar");
    const progressLabel = document.getElementById("progress-label");
    const progressPercent = document.getElementById("progress-percent");
    const pollIntervalMs = 5000;

    function updateProgressFromLog(text) {
      const lines = text.trim().split(/\r?\n/).reverse();
      let matchLine = null;
      for (const line of lines) {
        if (line.includes("%") && line.includes("]")) {
          matchLine = line;
          break;
        }
      }

      if (!matchLine) {
        progressBar.style.width = "0%";
        progressLabel.textContent = "Waiting for progress…";
        progressPercent.textContent = "0%";
        return;
      }

      const match = matchLine.match(/\]\s*(\d{1,3})%\s*(.*)$/);
      if (!match) {
        return;
      }

      const percent = Math.min(100, Math.max(0, parseInt(match[1], 10)));
      const label = match[2]?.trim() || "In progress";
      progressBar.style.width = `${percent}%`;
      progressLabel.textContent = label;
      progressPercent.textContent = `${percent}%`;
    }

    async function refreshLog() {
      try {
        const response = await fetch(window.location.href, { headers: { "X-Requested-With": "fetch" } });
        if (!response.ok) return;
        const text = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");
        const updated = doc.getElementById("log-output");
        if (updated && logOutput) {
          logOutput.textContent = updated.textContent;
          updateProgressFromLog(updated.textContent || "");
        }
      } catch (error) {
        // Ignore polling errors.
      }
    }

    async function refreshProgress() {
      try {
        const response = await fetch(`${window.location.pathname}/progress`);
        if (!response.ok) return;
        const data = await response.json();
        if (!data.available) {
          return;
        }
        const percent = data.percent ?? 0;
        progressBar.style.width = `${percent}%`;
        progressLabel.textContent = data.failed ? "Failed" : (data.label || "Progress");
        progressPercent.textContent = `${percent}%`;
      } catch (error) {
        // Ignore polling errors.
      }
    }

    updateProgressFromLog(logOutput.textContent || "");
    setInterval(refreshLog, pollIntervalMs);
    setInterval(refreshProgress, pollIntervalMs);
  </script>
  </div>
</body>
</html>
