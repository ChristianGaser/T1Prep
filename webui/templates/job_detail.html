<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Job {{ job.id }}</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body data-theme="dark">
  <div class="container">
    <header>
      <div>
        <h1>Job {{ job.id }}</h1>
        <p><a href="/jobs">Back to jobs</a> | <a href="/">New job</a></p>
      </div>
      <button class="theme-toggle" type="button" id="theme-toggle">Dark mode</button>
    </header>

  <div class="card meta">
    <p><strong>Status:</strong> <span id="job-status">{{ job.status }}</span></p>
    <p><strong>Phase:</strong> <span id="job-phase">Initializing</span></p>
    <p><strong>Created:</strong> {{ job.created_at }}</p>
    <p><strong>Scheduled for:</strong> {{ job.scheduled_for or "" }}</p>
    <p><strong>Started:</strong> <span id="job-started">{{ job.started_at or "" }}</span></p>
    <p><strong>Finished:</strong> <span id="job-finished">{{ job.finished_at or "" }}</span></p>
    <p><strong>Return code:</strong> <span id="job-return-code">{{ job.return_code if job.return_code is not none else "" }}</span></p>
  </div>

  <h2>Command</h2>
  <pre>{{ job.command_display }}</pre>

  <h2>Progress</h2>
  
  <div class="card progress-panel">
    <div class="progress-header">
      <span class="progress-title">Volume Segmentation</span>
      <span id="vol-time" class="progress-time"></span>
    </div>
    <div class="progress-track">
      <div id="vol-progress-bar" class="progress-bar"></div>
    </div>
    <div class="progress-meta">
      <span id="vol-progress-label">Waiting…</span>
      <span id="vol-progress-percent">0%</span>
    </div>
  </div>

  <div class="card progress-panel">
    <div class="progress-header">
      <span class="progress-title">Surface Estimation</span>
      <span id="surf-time" class="progress-time"></span>
    </div>
    <div class="progress-track">
      <div id="surf-progress-bar" class="progress-bar"></div>
    </div>
    <div class="progress-meta">
      <span id="surf-progress-label">Waiting…</span>
      <span id="surf-progress-percent">0%</span>
    </div>
  </div>

  <h2>Log</h2>
  <pre id="log-output">{{ log_content }}</pre>

  <script>
    const themeToggle = document.getElementById("theme-toggle");
    const savedTheme = localStorage.getItem("t1prep-theme") || "dark";
    document.body.setAttribute("data-theme", savedTheme);
    themeToggle.textContent = savedTheme === "dark" ? "Light mode" : "Dark mode";

    themeToggle.addEventListener("click", () => {
      const next = document.body.getAttribute("data-theme") === "dark" ? "light" : "dark";
      document.body.setAttribute("data-theme", next);
      localStorage.setItem("t1prep-theme", next);
      themeToggle.textContent = next === "dark" ? "Light mode" : "Dark mode";
    });

    const logOutput = document.getElementById("log-output");
    
    // Volume Segmentation elements
    const volProgressBar = document.getElementById("vol-progress-bar");
    const volProgressLabel = document.getElementById("vol-progress-label");
    const volProgressPercent = document.getElementById("vol-progress-percent");
    const volTime = document.getElementById("vol-time");
    
    // Surface Estimation elements
    const surfProgressBar = document.getElementById("surf-progress-bar");
    const surfProgressLabel = document.getElementById("surf-progress-label");
    const surfProgressPercent = document.getElementById("surf-progress-percent");
    const surfTime = document.getElementById("surf-time");
    
    // Status elements
    const jobStatus = document.getElementById("job-status");
    const jobPhase = document.getElementById("job-phase");
    const jobStarted = document.getElementById("job-started");
    const jobFinished = document.getElementById("job-finished");
    const jobReturnCode = document.getElementById("job-return-code");

    const pollIntervalMs = 2000;
    let isFinished = {{ 'true' if job.status in ('finished', 'failed') else 'false' }};

    async function refreshLog() {
      if (isFinished) return;
      try {
        const response = await fetch(window.location.href, { headers: { "X-Requested-With": "fetch" } });
        if (!response.ok) return;
        const text = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");
        const updated = doc.getElementById("log-output");
        if (updated && logOutput) {
          logOutput.textContent = updated.textContent;
        }
      } catch (error) {
        // Ignore polling errors.
      }
    }

    async function refreshProgress() {
      if (isFinished) return;
      try {
        const response = await fetch(`${window.location.pathname}/progress`);
        if (!response.ok) return;
        const data = await response.json();
        if (!data.available) {
          return;
        }
        
        // Update Volume Segmentation progress
        const vol = data.volume || {};
        const volPercent = vol.percent ?? 0;
        volProgressBar.style.width = `${volPercent}%`;
        volProgressPercent.textContent = `${volPercent}%`;
        
        if (vol.failed) {
          volProgressBar.classList.add("failed");
          volProgressLabel.textContent = "Failed";
        } else if (vol.complete) {
          volProgressBar.classList.remove("failed");
          volProgressLabel.textContent = "Complete";
          if (vol.time) {
            volTime.textContent = vol.time;
          }
        } else if (volPercent > 0) {
          volProgressBar.classList.remove("failed");
          volProgressLabel.textContent = "In progress";
        }
        
        // Update Surface Estimation progress
        const surf = data.surface || {};
        const surfPercent = surf.percent ?? 0;
        surfProgressBar.style.width = `${surfPercent}%`;
        surfProgressPercent.textContent = `${surfPercent}%`;
        
        if (surf.failed) {
          surfProgressBar.classList.add("failed");
          surfProgressLabel.textContent = "Failed";
        } else if (surf.complete) {
          surfProgressBar.classList.remove("failed");
          surfProgressLabel.textContent = "Complete";
          if (surf.time) {
            surfTime.textContent = surf.time;
          }
        } else if (surf.started) {
          surfProgressBar.classList.remove("failed");
          surfProgressLabel.textContent = "In progress";
        } else {
          surfProgressLabel.textContent = "Waiting…";
        }
        
      } catch (error) {
        // Ignore polling errors.
      }
    }

    async function refreshStatus() {
      try {
        const response = await fetch(`${window.location.pathname}/status`);
        if (!response.ok) return;
        const data = await response.json();

        if (data.status) {
          jobStatus.textContent = data.status;
          if (data.status === "finished") {
            jobStatus.style.color = "#4caf50";
            isFinished = true;
            // Final refresh to get completion state
            refreshProgress();
          } else if (data.status === "failed") {
            jobStatus.style.color = "#f44336";
            isFinished = true;
          } else if (data.status === "running") {
            jobStatus.style.color = "#2196f3";
          }
        }
        if (data.phase) {
          jobPhase.textContent = data.phase;
        }
        if (data.started_at) {
          jobStarted.textContent = data.started_at;
        }
        if (data.finished_at) {
          jobFinished.textContent = data.finished_at;
        }
        if (data.return_code !== null && data.return_code !== undefined) {
          jobReturnCode.textContent = data.return_code;
        }
      } catch (error) {
        // Ignore polling errors.
      }
    }

    // Initial refresh
    refreshStatus();
    refreshProgress();

    // Set up polling
    setInterval(refreshLog, pollIntervalMs);
    setInterval(refreshProgress, pollIntervalMs);
    setInterval(refreshStatus, pollIntervalMs);
  </script>
  </div>
</body>
</html>
